name: Build FFmpeg Binary for Android

on:
  push:
    branches: [ main, master ]
    paths:
      - 'build-ffmpeg-binary.sh'
      - '.github/workflows/build-ffmpeg.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version to build'
        required: false
        default: '6.1'

jobs:
  build:
    name: Build FFmpeg for Android ARMv8-A
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b
          add-to-path: true
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget \
            tar \
            xz-utils \
            build-essential \
            pkg-config \
            upx-ucl
      
      - name: Override FFmpeg version (if manual trigger)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.ffmpeg_version != ''
        run: |
          sed -i 's/FFMPEG_VERSION=".*"/FFMPEG_VERSION="${{ github.event.inputs.ffmpeg_version }}"/' build-ffmpeg-binary.sh
      
      - name: Build FFmpeg binary
        run: |
          chmod +x build-ffmpeg-binary.sh
          ./build-ffmpeg-binary.sh
      
      - name: Verify binaries
        run: |
          file output/bin/ffmpeg
          file output/bin/ffprobe
          du -h output/bin/ffmpeg
          du -h output/bin/ffprobe
      
      - name: Package binaries
        run: |
          cd output/bin
          tar -czf ../../ffmpeg-android-arm64.tar.gz ffmpeg ffprobe
          cd ../..
          ls -lh ffmpeg-android-arm64.tar.gz
      
      - name: Upload FFmpeg binary
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-android-arm64-binary
          path: output/bin/ffmpeg
          retention-days: 90
      
      - name: Upload FFprobe binary
        uses: actions/upload-artifact@v4
        with:
          name: ffprobe-android-arm64-binary
          path: output/bin/ffprobe
          retention-days: 90
      
      - name: Upload tarball
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-android-arm64-tarball
          path: ffmpeg-android-arm64.tar.gz
          retention-days: 90
      
      - name: Generate build info
        run: |
          cat > build-info.txt <<EOF
          FFmpeg Build Information
          ========================
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          FFmpeg Version: 6.1
          Android API Level: 24
          Architecture: ARMv8-A (arm64-v8a)
          NDK Version: r26b
          
          Configuration:
          - Minimal build for thumbnail generation
          - UPX compressed for maximum size reduction
          - Protocols: file, http, https, tcp, udp, crypto
          - Demuxers: mov, matroska, mp4, avi, mpegts, flv, webm
          - Decoders: h264, hevc, vp8, vp9
          - Encoders: mjpeg, png
          - Parsers: h264, hevc, vp8, vp9
          
          Binary Sizes:
          - ffmpeg: $(du -h output/bin/ffmpeg | cut -f1)
          - ffprobe: $(du -h output/bin/ffprobe | cut -f1)
          
          Usage on Android:
          1. adb push ffmpeg /data/local/tmp/
          2. adb shell chmod +x /data/local/tmp/ffmpeg
          3. adb shell /data/local/tmp/ffmpeg -version
          EOF
          
          cat build-info.txt
      
      - name: Upload build info
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: build-info.txt
          retention-days: 90
      
      - name: Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ffmpeg-android-arm64.tar.gz
            build-info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
